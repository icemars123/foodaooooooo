"use strict";var Admin=require("../middleware/Admin"),Auth=require("../middleware/Auth"),jwt=require("jsonwebtoken"),config=require("config"),bcrypt=require("bcrypt"),_=require("lodash"),_require=require("../models/User"),User=_require.User,validateUser=_require.validateUser,csurf=require("csurf"),express=require("express"),router=express.Router();router.get("/",function(e,r,t){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(User.find());case 3:s=e.sent,r.status(200).json({message:"Handling GET requests to /users.",docs:s}),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.log(e.t0),r.status(500).json({error:e.t0}),t();case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/me",Auth,function(r,t,s){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(User.findOne({phone:r.user.phone}).select("-password"));case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",t.status(404).send("The user with the given ID is not found."));case 6:t.status(200).send(n),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),t.status(500).json({error:e.t0}),s();case 13:case"end":return e.stop()}},null,null,[[0,9]])}),router.post("/register",function(r,t,s){var n,a,u,o,i,d,c,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.body,a=n.password,u=n.password2,a!==u)return e.abrupt("return",t.status(400).send({message:"Passwords do not match"}));e.next=3;break;case 3:if(o=validateUser(r.body),i=o.error)return e.abrupt("return",t.status(400).send(i.details[0].message));e.next=6;break;case 6:return e.prev=6,e.next=9,regeneratorRuntime.awrap(User.findOne({phone:r.body.phone}));case 9:if(d=e.sent)return e.abrupt("return",t.status(400).json({message:"User already registered."}));e.next=12;break;case 12:return d=new User(_.pick(r.body,["name","phone","email","password","registerDate","birth","sex","isAdmin"])),e.next=15,regeneratorRuntime.awrap(bcrypt.genSalt(10));case 15:return c=e.sent,e.next=18,regeneratorRuntime.awrap(bcrypt.hash(d.password,c));case 18:return d.password=e.sent,e.next=21,regeneratorRuntime.awrap(d.save());case 21:d=e.sent,p=d.generateAuthToken(),t.status(201).header("x-auth-token",p).json({user:d}),e.next=31;break;case 26:e.prev=26,e.t0=e.catch(6),console.log(e.t0),t.status(500).json({error:e.t0}),s();case 31:case"end":return e.stop()}},null,null,[[6,26]])}),router.put("/:id",function(r,e,t){var s=users.find(function(e){return e.id===parseInt(r.params.id)});if(!s)return e.status(404).send("The user with the given ID is not found");var n=validateUser(r.body).error;if(n)return e.status(400).send(n.details[0].message);s.name=r.body.name,e.send(s)}),router.delete("/:id",function(r,e,t){var s=users.find(function(e){return e.id===parseInt(r.params.id)});if(!s)return e.status(404).send("The user with the given ID is not found");var n=users.indexOf(s);users.splice(n,1),e.send(s)}),module.exports=router;